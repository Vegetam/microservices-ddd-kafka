version: '3.9'

services:
  # ── Kafka ──────────────────────────────────────────────────────
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    depends_on: [zookeeper]
    ports:
      - '9092:9092'
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    ports:
      - '8090:8080'
    depends_on: [kafka]
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092

  # ── Databases ──────────────────────────────────────────────────
  postgres-orders:
    image: postgres:15-alpine
    ports:
      - '5432:5432'
    environment:
      POSTGRES_DB: orders_db
      POSTGRES_USER: orders_user
      POSTGRES_PASSWORD: orders_pass
    volumes:
      - ./src/OrderService/Infrastructure/persistence/migrations:/docker-entrypoint-initdb.d:ro

  postgres-payments:
    image: postgres:15-alpine
    ports:
      - '5433:5432'
    environment:
      POSTGRES_DB: payments_db
      POSTGRES_USER: payments_user
      POSTGRES_PASSWORD: payments_pass
    volumes:
      - ./src/PaymentService/Infrastructure/persistence/migrations:/docker-entrypoint-initdb.d:ro

  # ── Cache ──────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    ports:
      - '6379:6379'

  # ── Microservices ──────────────────────────────────────────────
  order-service:
    build:
      context: .
      dockerfile: ./src/OrderService/Dockerfile
    depends_on:
      - kafka
      - postgres-orders
      - redis
    environment:
      PORT: 3000
      DATABASE_URL: postgresql://orders_user:orders_pass@postgres-orders:5432/orders_db
      KAFKA_BROKERS: kafka:29092
      KAFKA_CLIENT_ID: order-service
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - '3001:3000'

  payment-service:
    build:
      context: .
      dockerfile: ./src/PaymentService/Dockerfile
    depends_on:
      - kafka
      - postgres-payments
    environment:
      PORT: 3000
      DATABASE_URL: postgresql://payments_user:payments_pass@postgres-payments:5432/payments_db
      KAFKA_BROKERS: kafka:29092
      KAFKA_CLIENT_ID: payment-service
      DEFAULT_PAYMENT_METHOD_ID: pm_simulated
    ports:
      - '3002:3000'

  notification-service:
    build:
      context: .
      dockerfile: ./src/NotificationService/Dockerfile
    depends_on:
      - kafka
    environment:
      PORT: 3000
      KAFKA_BROKERS: kafka:29092
      KAFKA_CLIENT_ID: notification-service
    ports:
      - '3003:3000'

